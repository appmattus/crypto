/*
 * Copyright 2021 Appmattus Limited
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package com.appmattus.crypto.internal

import com.appmattus.crypto.Algorithm
import com.appmattus.crypto.Digest
import com.appmattus.crypto.internal.core.sphlib.testCollision
import com.appmattus.crypto.internal.core.sphlib.testKat
import com.appmattus.crypto.internal.core.sphlib.testKatExtremelyLong
import com.appmattus.crypto.internal.core.sphlib.testKatMillionA
import kotlin.test.AfterTest
import kotlin.test.BeforeTest
import kotlin.test.Ignore
import kotlin.test.Test
import kotlin.test.assertNotNull
import kotlin.test.fail

class SHA1CoreTest : SHA1Test() {
    override fun digest(): Digest<*> = CoreDigest.create(Algorithm.SHA_1)

    @Test
    fun hasImplementation() {
        assertNotNull(digest())
    }
}

class SHA1PlatformTest : SHA1Test() {
    override fun digest(): Digest<*> = PlatformDigest().create(Algorithm.SHA_1) ?: fail()

    @Test
    fun hasImplementation() {
        assertNotNull(digest())
    }
}

// On iOS this test is equivalent to the "...PlatformTest"
class SHA1InstalledProviderTest : SHA1Test() {

    @BeforeTest
    fun beforeTest() {
        installPlatformProvider()
    }

    @AfterTest
    fun afterTest() {
        removePlatformProvider()
    }

    override fun digest(): Digest<*> = PlatformDigest().create(Algorithm.SHA_1) ?: fail()

    @Test
    fun hasImplementation() {
        assertNotNull(digest())
    }
}

/**
 * Test SHA-1 implementation.
 */
abstract class SHA1Test {

    abstract fun digest(): Digest<*>

    /**
     * From https://www.di-mgt.com.au/sha_testvectors.html
     */
    @Test
    fun empty() {
        testKat(digest(), "", "da39a3ee5e6b4b0d3255bfef95601890afd80709")
    }

    @Test
    fun nist112chars() {
        testKat(
            dig = digest(),
            data = "abcdefghbcdefghicdefghijdefghijkefghijklfghijklmghijklmnhijklmnoijklmnopjklmnopqklmnopqrlmnopqrsmnopqrstnopqrstu",
            ref = "a49b2446a02c645bf419f995b67091253a04a259"
        )
    }

    @Test
    fun oneMillionA() {
        testKatMillionA(
            digest(),
            "34aa973cd4c4daa4f61eeb2bdbad27316534016f"
        )
    }

    @Test
    @Ignore
    fun reallyLong() {
        testKatExtremelyLong(
            digest(),
            "7789f0c9ef7bfc40d93311143dfbe69e2017f592"
        )
    }

    /**
     * From https://csrc.nist.gov/csrc/media/projects/cryptographic-standards-and-guidelines/documents/examples/sha_all.pdf
     */

    @Test
    fun nistAbc() {
        testKat(digest(), "abc", "a9993e364706816aba3e25717850c26c9cd0d89d")
    }

    @Test
    fun nist56chars() {
        testKat(
            digest(),
            "abcdbcdecdefdefgefghfghighijhijkijkljklmklmnlmnomnopnopq",
            "84983e441c3bd26ebaae4aa1f95129e5e54670f1"
        )
    }

    /**
     * From https://shattered.io/static/shattered.pdf
     */
    @Test
    fun shatteredCollision() {
        testCollision(digest(), goodPdf, badPdf)
    }

    /**
     * From https://sha-mbles.github.io
     */
    @Test
    fun shamblesCollision() {
        testCollision(
            dig = digest(),
            s1 = "99040d047fe81780012000ff4b65792069732070617274206f6620612063" +
                    "6f6c6c6973696f6e212049742773206120747261702179c61af0afcc0545" +
                    "15d9274e7307624b1dc7fb23988bb8de8b575dba7b9eab31c1674b6d9743" +
                    "78a827732ff5851c76a2e60772b5a47ce1eac40bb993c12d8c70e24a4f8d" +
                    "5fcdedc1b32c9cf19e31af2429759d42e4dfdb31719f587623ee552939b6" +
                    "dcdc459fca53553b70f87ede30a247ea3af6c759a2f20b320d760db64ff4" +
                    "79084fd3ccb3cdd48362d96a9c430617caff6c36c637e53fde28417f626f" +
                    "ec54ed7943a46e5f5730f2bb38fb1df6e0090010d00e24ad78bf92641993" +
                    "608e8d158a789f34c46fe1e6027f35a4cbfb827076c50eca0e8b7cca69bb" +
                    "2c2b790259f9bf9570dd8d4437a3115faff7c3cac09ad25266055c271047" +
                    "55178eaeff825a2caa2acfb5de64ce7641dc59a541a9fc9c756756e2e23d" +
                    "c713c8c24c9790aa6b0e38a7f55f14452a1ca2850ddd9562fd9a18ad4249" +
                    "6aa97008f74672f68ef461eb88b09933d626b4f918749cc027fddd6c425f" +
                    "c4216835d0134d15285bab2cb784a4f7cbb4fb514d4bf0f6237cf00a9e9f" +
                    "132b9a066e6fd17f6c42987478586ff651af96747fb426b9872b9a88e406" +
                    "3f59bb334cc00650f83a80c42751b71974d300fc2819a2e8f1e32c1b51cb" +
                    "18e6bfc4db9baef675d4aaf5b1574a047f8f6dd2ec153a93412293974d92" +
                    "8f88ced9363cfef97ce2e742bf34c96b8ef3875676fea5cca8e5f7dea0ba" +
                    "b2413d4de00ee71ee01f162bdb6d1eafd925e6aebaae6a354ef17cf205a4" +
                    "04fbdb12fc454d41fdd95cf2459664a2ad032d1da60a73264075d7f1e0d6" +
                    "c1403ae7a0d861df3fe5707188dd5e07d1589b9f8b6630553f8fc352b3e0" +
                    "c27da80bddba4c64020d",
            s2 = "99030d047fe81780011800ff50726163746963616c205348412d31206368" +
                    "6f73656e2d70726566697820636f6c6c6973696f6e211d276c6ba661e104" +
                    "0e1f7d767f076249ddc7fb332c8bb8c2b7575dbec79eab2be1674b7db343" +
                    "78b4cb732fe1891c76a0260772a5107ce1f6e80bb9977d2d8c68524a4f9d" +
                    "5fcdedcd0b2c9ce19231af26e9759d5250dfdb2d4d9f58729fee553319b6" +
                    "dccc619fca4fb93b70ec72de30a087ea3ae67359a2ee27320d72b1b64fec" +
                    "c9084fc3ccb3cdd83b62d97a904306150aff6c267237e523e228417bde6f" +
                    "ec4ecd7943b44a5f572c1ebb38ef11f6e00bc010d01e90ad78a3be641997" +
                    "dc8e8d0d3a789f24c46fe1eaba7f35b4c7fb8272b6c50edaba8b7cd655bb" +
                    "2c2fc50259e39f9570cda94437bffd5fafe3cfcac09812526615e827105b" +
                    "79178eaa43825a341a2acfa5de64ce7af9dc59b54da9fc9eb56756f2563d" +
                    "c70ff4c24c932caa6b1418a7f54f30452a004e850dc99962fd98d8ad4259" +
                    "dea97014db4672f232f461f338b09923d626b4f5a0749cd02bfddd6e825f" +
                    "c431dc35d00f7115285f172cb79e84f7cba4df514d571cf62368fc0a9e9d" +
                    "d32b9a16da6fd16340429870c4586feee1af96647fb426b53f2b9a98e806" +
                    "3f5b7b334cd0b250f826bcc427550b1974c920fc280986e8f1ffc01b51df" +
                    "14e6bfc61b9baee6c1d4aae99d574a00c38f6dca5c153a834122939bf592" +
                    "8f98c2d9363e3ef97cf25342bf28f56b8ef73b5676e485cca8f5d3dea0a6" +
                    "5e413d59ec0ee71c201f163b6f6d1eb3f525e6aa06ae6a2dfef17ce205a4" +
                    "04f76312fc554141fddb9cf24586d0a2ad1f111da60ecf26406ff7f1e0c6" +
                    "e5403afb4cd861cb33e5707348dd5e1765589b83a7663051838fc34a03e0" +
                    "c26da80bddb6f464021d"
        )
    }

    companion object {
        private const val goodPdf = "255044462d312e330a25e2e3cfd30a0a0a312030206f626a0a3c3c2f5769" +
                "6474682032203020522f4865696768742033203020522f54797065203420" +
                "3020522f537562747970652035203020522f46696c746572203620302052" +
                "2f436f6c6f7253706163652037203020522f4c656e677468203820302052" +
                "2f42697473506572436f6d706f6e656e7420383e3e0a73747265616d0aff" +
                "d8fffe00245348412d3120697320646561642121212121852fec09233975" +
                "9c39b1a1c63c4c97e1fffe017f46dc93a6b67e013b029aaa1db2560b45ca" +
                "67d688c7f84b8c4c791fe02b3df614f86db1690901c56b45c1530afedfb7" +
                "6038e972722fe7ad728f0e4904e046c230570fe9d41398abe12ef5bc942b" +
                "e33542a4802d98b5d70f2a332ec37fac3514e74ddc0f2cc1a874cd0c7830" +
                "5a21566461309789606bd0bf3f98cda8044629a100000000000000000000" +
                "000000000000000000000000000000000000000000000000000000000000" +
                "000000000000000000000000000000000000000000000000000000000000" +
                "000000000000000000000000000000000000000000000000000000000000" +
                "000000000000000000000000000000000000000000000000000000000000" +
                "000000000000000000000000000000000000000000000000000000000000" +
                "000000000000000000000000000000000000000000000000000000000000" +
                "000000000000000000000000000000000000000000000000000000000000" +
                "00000000000000000000000000000000000000000000fffe00fe00000000" +
                "00000000ffe000104a46494600010101004800480000fffe001343726561" +
                "74656420776974682047494d50ffdb004300010101010101010101010101" +
                "010101010101010101010101010101010101010101010101010101010101" +
                "01010101010101010101010101010101010101010101ffdb004301010101" +
                "010101010101010101010101010101010101010101010101010101010101" +
                "010101010101010101010101010101010101010101010101010101010101" +
                "01ffc20011080008000803011100021101031101ffc40014000100000000" +
                "000000000000000000000008ffc400140101000000000000000000000000" +
                "00000009fffe0006fffe002fffda000c03010002100310000001539dc51f" +
                "ffc4001510010100000000000000000000000000001626fffe0006fffe00" +
                "33ffda0008010100010502a953ffc4001f11000003090000000000000000" +
                "00000000141517001316274563658695fffe0006fffe0041ffda00080103" +
                "01013f019a8aa56d533bb238739e612166b90e605bffc4001e1100000407" +
                "0000000000000000000000000014151713274563658594fffe0006fffe00" +
                "40ffda0008010201013f01984e1555c155b66cdc3e04a21a444c40ffc400" +
                "1e10000101090000000000000000000000001413001215164462648594ff" +
                "fe0006fffe0033ffda0008010100063f02ad9a4db175dce6086d743b05bf" +
                "ffc40014100100000000000000000000000000000000fffe0006fffe0012" +
                "ffda0008010100013f216001fffe0006fffe002bffda000c030100020003" +
                "000000101fffc40014110100000000000000000000000000000000fffe00" +
                "06fffe0028ffda0008010301013f106980ffc40014110100000000000000" +
                "000000000000000000fffe0006fffe0028ffda0008010201013f106bc7ff" +
                "c40014100100000000000000000000000000000000fffe0006fffe0014ff" +
                "da0008010100013f10153fffd9414e4745ffe000104a4649460001010100" +
                "4800480000fffe00134372656174656420776974682047494d50ffdb0043" +
                "000101010101010101010101010101010101010101010101010101010101" +
                "010101010101010101010101010101010101010101010101010101010101" +
                "0101010101ffdb0043010101010101010101010101010101010101010101" +
                "010101010101010101010101010101010101010101010101010101010101" +
                "0101010101010101010101010101ffc20011080008000803011100021101" +
                "031101ffc40014000100000000000000000000000000000009ffc4001501" +
                "010100000000000000000000000000000607ffda000c0301000210031000" +
                "0001524a5fff00ffc40014100100000000000000000000000000000000ff" +
                "da00080101000105027fffc4001811000203000000000000000000000000" +
                "0000f037a7b7ffda0008010301013f01dfdbfd9fcfffc400181100020300" +
                "00000000000000000000000000f036a6b6ffda0008010201013f01ca3546" +
                "287fffc40018100002030000000000000000000000000000f03767a7ffda" +
                "0008010100063f02a99c99898fffc4001410010000000000000000000000" +
                "0000000000ffda0008010100013f217fffda000c03010002000300000010" +
                "1fffc40014110100000000000000000000000000000000ffda0008010301" +
                "013f100fffc40014110100000000000000000000000000000000ffda0008" +
                "010201013f100fffc40014100100000000000000000000000000000000ff" +
                "da0008010100013f100fffd90a656e6473747265616d0a656e646f626a0a" +
                "0a322030206f626a0a380a656e646f626a0a0a332030206f626a0a380a65" +
                "6e646f626a0a0a342030206f626a0a2f584f626a6563740a656e646f626a" +
                "0a0a352030206f626a0a2f496d6167650a656e646f626a0a0a362030206f" +
                "626a0a2f4443544465636f64650a656e646f626a0a0a372030206f626a0a" +
                "2f4465766963655247420a656e646f626a0a0a382030206f626a0a313639" +
                "330a656e646f626a0a0a392030206f626a0a3c3c0a20202f54797065202f" +
                "436174616c6f670a20202f5061676573203130203020520a3e3e0a656e64" +
                "6f626a0a0a0a31302030206f626a0a3c3c0a20202f54797065202f506167" +
                "65730a20202f436f756e7420310a20202f4b696473205b3131203020525d" +
                "0a3e3e0a656e646f626a0a0a31312030206f626a0a3c3c0a20202f547970" +
                "65202f506167650a20202f506172656e74203130203020520a20202f4d65" +
                "646961426f78205b302030203820385d0a20202f43726f70426f78205b30" +
                "2030203820385d0a20202f436f6e74656e7473203132203020520a20202f" +
                "5265736f75726365730a20203c3c0a202020202f584f626a656374203c3c" +
                "2f496d302031203020523e3e0a20203e3e0a3e3e0a656e646f626a0a0a31" +
                "322030206f626a0a3c3c2f4c656e6774682033303e3e0a73747265616d0a" +
                "710a2020382030203020382030203020636d0a20202f496d3020446f0a51" +
                "0a656e6473747265616d0a656e646f626a0a0a0a0a787265660a30203133" +
                "200a303030303030303030302036353533352066200a3030303030303030" +
                "3137203030303030206e200a30303030303031383631203030303030206e" +
                "200a30303030303031383739203030303030206e200a3030303030303138" +
                "3937203030303030206e200a30303030303031393232203030303030206e" +
                "200a30303030303031393435203030303030206e200a3030303030303139" +
                "3732203030303030206e200a30303030303031393939203030303030206e" +
                "200a30303030303032303230203030303030206e200a3030303030303230" +
                "3736203030303030206e200a30303030303032313432203030303030206e" +
                "200a30303030303032333039203030303030206e200a0a747261696c6572" +
                "203c3c202f526f6f74203920302052202f53697a652031333e3e0a0a7374" +
                "617274787265660a323339310a2525454f460a"

        private const val badPdf = "255044462d312e330a25e2e3cfd30a0a0a312030206f626a0a3c3c2f5769" +
                "6474682032203020522f4865696768742033203020522f54797065203420" +
                "3020522f537562747970652035203020522f46696c746572203620302052" +
                "2f436f6c6f7253706163652037203020522f4c656e677468203820302052" +
                "2f42697473506572436f6d706f6e656e7420383e3e0a73747265616d0aff" +
                "d8fffe00245348412d3120697320646561642121212121852fec09233975" +
                "9c39b1a1c63c4c97e1fffe017346dc9166b67e118f029ab621b2560ff9ca" +
                "67cca8c7f85ba84c79030c2b3de218f86db3a90901d5df45c14f26fedfb3" +
                "dc38e96ac22fe7bd728f0e45bce046d23c570feb141398bb552ef5a0a82b" +
                "e331fea48037b8b5d71f0e332edf93ac3500eb4ddc0decc1a864790c782c" +
                "76215660dd309791d06bd0af3f98cda4bc4629b100000000000000000000" +
                "000000000000000000000000000000000000000000000000000000000000" +
                "000000000000000000000000000000000000000000000000000000000000" +
                "000000000000000000000000000000000000000000000000000000000000" +
                "000000000000000000000000000000000000000000000000000000000000" +
                "000000000000000000000000000000000000000000000000000000000000" +
                "000000000000000000000000000000000000000000000000000000000000" +
                "000000000000000000000000000000000000000000000000000000000000" +
                "00000000000000000000000000000000000000000000fffe00fe00000000" +
                "00000000ffe000104a46494600010101004800480000fffe001343726561" +
                "74656420776974682047494d50ffdb004300010101010101010101010101" +
                "010101010101010101010101010101010101010101010101010101010101" +
                "01010101010101010101010101010101010101010101ffdb004301010101" +
                "010101010101010101010101010101010101010101010101010101010101" +
                "010101010101010101010101010101010101010101010101010101010101" +
                "01ffc20011080008000803011100021101031101ffc40014000100000000" +
                "000000000000000000000008ffc400140101000000000000000000000000" +
                "00000009fffe0006fffe002fffda000c03010002100310000001539dc51f" +
                "ffc4001510010100000000000000000000000000001626fffe0006fffe00" +
                "33ffda0008010100010502a953ffc4001f11000003090000000000000000" +
                "00000000141517001316274563658695fffe0006fffe0041ffda00080103" +
                "01013f019a8aa56d533bb238739e612166b90e605bffc4001e1100000407" +
                "0000000000000000000000000014151713274563658594fffe0006fffe00" +
                "40ffda0008010201013f01984e1555c155b66cdc3e04a21a444c40ffc400" +
                "1e10000101090000000000000000000000001413001215164462648594ff" +
                "fe0006fffe0033ffda0008010100063f02ad9a4db175dce6086d743b05bf" +
                "ffc40014100100000000000000000000000000000000fffe0006fffe0012" +
                "ffda0008010100013f216001fffe0006fffe002bffda000c030100020003" +
                "000000101fffc40014110100000000000000000000000000000000fffe00" +
                "06fffe0028ffda0008010301013f106980ffc40014110100000000000000" +
                "000000000000000000fffe0006fffe0028ffda0008010201013f106bc7ff" +
                "c40014100100000000000000000000000000000000fffe0006fffe0014ff" +
                "da0008010100013f10153fffd9414e4745ffe000104a4649460001010100" +
                "4800480000fffe00134372656174656420776974682047494d50ffdb0043" +
                "000101010101010101010101010101010101010101010101010101010101" +
                "010101010101010101010101010101010101010101010101010101010101" +
                "0101010101ffdb0043010101010101010101010101010101010101010101" +
                "010101010101010101010101010101010101010101010101010101010101" +
                "0101010101010101010101010101ffc20011080008000803011100021101" +
                "031101ffc40014000100000000000000000000000000000009ffc4001501" +
                "010100000000000000000000000000000607ffda000c0301000210031000" +
                "0001524a5fff00ffc40014100100000000000000000000000000000000ff" +
                "da00080101000105027fffc4001811000203000000000000000000000000" +
                "0000f037a7b7ffda0008010301013f01dfdbfd9fcfffc400181100020300" +
                "00000000000000000000000000f036a6b6ffda0008010201013f01ca3546" +
                "287fffc40018100002030000000000000000000000000000f03767a7ffda" +
                "0008010100063f02a99c99898fffc4001410010000000000000000000000" +
                "0000000000ffda0008010100013f217fffda000c03010002000300000010" +
                "1fffc40014110100000000000000000000000000000000ffda0008010301" +
                "013f100fffc40014110100000000000000000000000000000000ffda0008" +
                "010201013f100fffc40014100100000000000000000000000000000000ff" +
                "da0008010100013f100fffd90a656e6473747265616d0a656e646f626a0a" +
                "0a322030206f626a0a380a656e646f626a0a0a332030206f626a0a380a65" +
                "6e646f626a0a0a342030206f626a0a2f584f626a6563740a656e646f626a" +
                "0a0a352030206f626a0a2f496d6167650a656e646f626a0a0a362030206f" +
                "626a0a2f4443544465636f64650a656e646f626a0a0a372030206f626a0a" +
                "2f4465766963655247420a656e646f626a0a0a382030206f626a0a313639" +
                "330a656e646f626a0a0a392030206f626a0a3c3c0a20202f54797065202f" +
                "436174616c6f670a20202f5061676573203130203020520a3e3e0a656e64" +
                "6f626a0a0a0a31302030206f626a0a3c3c0a20202f54797065202f506167" +
                "65730a20202f436f756e7420310a20202f4b696473205b3131203020525d" +
                "0a3e3e0a656e646f626a0a0a31312030206f626a0a3c3c0a20202f547970" +
                "65202f506167650a20202f506172656e74203130203020520a20202f4d65" +
                "646961426f78205b302030203820385d0a20202f43726f70426f78205b30" +
                "2030203820385d0a20202f436f6e74656e7473203132203020520a20202f" +
                "5265736f75726365730a20203c3c0a202020202f584f626a656374203c3c" +
                "2f496d302031203020523e3e0a20203e3e0a3e3e0a656e646f626a0a0a31" +
                "322030206f626a0a3c3c2f4c656e6774682033303e3e0a73747265616d0a" +
                "710a2020382030203020382030203020636d0a20202f496d3020446f0a51" +
                "0a656e6473747265616d0a656e646f626a0a0a0a0a787265660a30203133" +
                "200a303030303030303030302036353533352066200a3030303030303030" +
                "3137203030303030206e200a30303030303031383631203030303030206e" +
                "200a30303030303031383739203030303030206e200a3030303030303138" +
                "3937203030303030206e200a30303030303031393232203030303030206e" +
                "200a30303030303031393435203030303030206e200a3030303030303139" +
                "3732203030303030206e200a30303030303031393939203030303030206e" +
                "200a30303030303032303230203030303030206e200a3030303030303230" +
                "3736203030303030206e200a30303030303032313432203030303030206e" +
                "200a30303030303032333039203030303030206e200a0a747261696c6572" +
                "203c3c202f526f6f74203920302052202f53697a652031333e3e0a0a7374" +
                "617274787265660a323339310a2525454f460a"
    }
}
