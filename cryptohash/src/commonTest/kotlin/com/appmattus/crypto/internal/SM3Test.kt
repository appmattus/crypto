/*
 * Copyright 2021 Appmattus Limited
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package com.appmattus.crypto.internal

import com.appmattus.crypto.Algorithm
import com.appmattus.crypto.Digest
import com.appmattus.crypto.internal.core.sphlib.testKat
import com.appmattus.crypto.internal.core.sphlib.testKatHex
import kotlin.test.AfterTest
import kotlin.test.BeforeTest
import kotlin.test.Test
import kotlin.test.assertNotNull
import kotlin.test.assertNull

class SM3CoreTest : SM3Test() {
    override fun digest(): Digest<*> = CoreDigest.create(Algorithm.SM3)

    @Test
    fun hasImplementation() {
        assertNotNull(digest())
    }
}

// No built-in support
class SM3InstalledProviderTest {

    @BeforeTest
    fun beforeTest() {
        installPlatformProvider()
    }

    @AfterTest
    fun afterTest() {
        removePlatformProvider()
    }

    @Test
    fun noImplementation() {
        assertNull(PlatformDigest().create(Algorithm.SM3))
    }
}

/**
 * Test SM3 implementation.
 */
abstract class SM3Test {

    abstract fun digest(): Digest<*>

    // From https://tools.ietf.org/html/draft-oscca-cfrg-sm3-01
    @Test
    fun specification() {
        // Example 1, From GB/T 32905-2016
        testKat(
            digest(),
            "abc",
            "66c7f0f462eeedd9d1f2d46bdc10e4e24167c4875cf2f7a2297da02b8f4ba8e0"
        )

        // Example 2, From GB/T 32905-2016
        testKat(
            digest(),
            "abcdabcdabcdabcdabcdabcdabcdabcdabcdabcdabcdabcdabcdabcdabcdabcd",
            "debe9ff92275b8a138604889c18e5a4d6fdb70e5387e5765293dcba39c0c5732"
        )

        // GB/T 32918.2-2016 A.2 Example 1
        testKatHex(
            digest(),
            "0090414C494345313233405941484F4F2E434F4D" +
                    "787968B4FA32C3FD2417842E73BBFEFF2F3C848B6831D7E0EC65228B3937E498" +
                    "63E4C6D3B23B0C849CF84241484BFE48F61D59A5B16BA06E6E12D1DA27C5249A" +
                    "421DEBD61B62EAB6746434EBC3CC315E32220B3BADD50BDC4C4E6C147FEDD43D" +
                    "0680512BCBB42C07D47349D2153B70C4E5D7FDFCBFA36EA1A85841B9E46E09A2" +
                    "0AE4C7798AA0F119471BEE11825BE46202BB79E2A5844495E97C04FF4DF2548A" +
                    "7C0240F88F1CD4E16352A73C17B7F16F07353E53A176D684A9FE0C6BB798E857",
            "F4A38489E32B45B6F876E3AC2168CA392362DC8F23459C1D1146FC3DBFB7BC9A"
        )

        // GB/T 32918.2-2016 A.2 Example 2
        testKatHex(
            digest(),
            "F4A38489E32B45B6F876E3AC2168CA392362DC8F23459C1D1146FC3DBFB7BC9A6D65737361676520646967657374",
            "B524F552CD82B8B028476E005C377FB19A87E6FC682D48BB5D42E3D9B9EFFE76"
        )

        // GB/T 32918.2-2016 A.3 Example 1
        testKatHex(
            digest(),
            "0090414C494345313233405941484F4F2E434F4D00" +
                    "000000000000000000000000000000000000000000000000000000000000000000" +
                    "E78BCD09746C202378A7E72B12BCE00266B9627ECB0B5A25367AD1AD4CC6242B00" +
                    "CDB9CA7F1E6B0441F658343F4B10297C0EF9B6491082400A62E7A7485735FADD01" +
                    "3DE74DA65951C4D76DC89220D5F7777A611B1C38BAE260B175951DC8060C2B3E01" +
                    "65961645281A8626607B917F657D7E9382F1EA5CD931F40F6627F357542653B201" +
                    "686522130D590FB8DE635D8FCA715CC6BF3D05BEF3F75DA5D543454448166612",
            "26352AF82EC19F207BBC6F9474E11E90CE0F7DDACE03B27F801817E897A81FD5"
        )

        // GB/T 32918.2-2016 A.3 Example 2
        testKatHex(
            digest(),
            "26352AF82EC19F207BBC6F9474E11E90CE0F7DDACE03B27F801817E897A81FD5" +
                    "6D65737361676520646967657374",
            "AD673CBDA311417129A9EAA5F9AB1AA1633AD47718A84DFD46C17C6FA0AA3B12"
        )

        // GB/T 32918.3-2016 A.2 Example 1
        testKatHex(
            digest(),
            "0090414C494345313233405941484F4F2E434F4D" +
                    "787968B4FA32C3FD2417842E73BBFEFF2F3C848B6831D7E0EC65228B3937E498" +
                    "63E4C6D3B23B0C849CF84241484BFE48F61D59A5B16BA06E6E12D1DA27C5249A" +
                    "421DEBD61B62EAB6746434EBC3CC315E32220B3BADD50BDC4C4E6C147FEDD43D" +
                    "0680512BCBB42C07D47349D2153B70C4E5D7FDFCBFA36EA1A85841B9E46E09A2" +
                    "3099093BF3C137D8FCBBCDF4A2AE50F3B0F216C3122D79425FE03A45DBFE1655" +
                    "3DF79E8DAC1CF0ECBAA2F2B49D51A4B387F2EFAF482339086A27A8E05BAED98B",
            "E4D1D0C3CA4C7F11BC8FF8CB3F4C02A78F108FA098E51A668487240F75E20F31"
        )

        // GB/T 32918.3-2016 A.2 Example 2
        testKatHex(
            digest(),
            "008842494C4C343536405941484F4F2E434F4D" +
                    "787968B4FA32C3FD2417842E73BBFEFF2F3C848B6831D7E0EC65228B3937E498" +
                    "63E4C6D3B23B0C849CF84241484BFE48F61D59A5B16BA06E6E12D1DA27C5249A" +
                    "421DEBD61B62EAB6746434EBC3CC315E32220B3BADD50BDC4C4E6C147FEDD43D" +
                    "0680512BCBB42C07D47349D2153B70C4E5D7FDFCBFA36EA1A85841B9E46E09A2" +
                    "245493D446C38D8CC0F118374690E7DF633A8A4BFB3329B5ECE604B2B4F37F43" +
                    "53C0869F4B9E17773DE68FEC45E14904E0DEA45BF6CECF9918C85EA047C60A4C",
            "6B4B6D0E276691BD4A11BF72F4FB501AE309FDACB72FA6CC336E6656119ABD67"
        )

        // GB/T 32918.3-2016 A.2 Example 3
        testKatHex(
            digest(),
            "47C826534DC2F6F1FBF28728DD658F21E174F48179ACEF2900F8B7F566E40905" +
                    "E4D1D0C3CA4C7F11BC8FF8CB3F4C02A78F108FA098E51A668487240F75E20F31" +
                    "6B4B6D0E276691BD4A11BF72F4FB501AE309FDACB72FA6CC336E6656119ABD67" +
                    "6CB5633816F4DD560B1DEC458310CBCC6856C09505324A6D23150C408F162BF0" +
                    "0D6FCF62F1036C0A1B6DACCF57399223A65F7D7BF2D9637E5BBBEB857961BF1A" +
                    "1799B2A2C778295300D9A2325C686129B8F2B5337B3DCF4514E8BBC19D900EE5" +
                    "54C9288C82733EFDF7808AE7F27D0E732F7C73A7D9AC98B7D8740A91D0DB3CF4",
            "FF49D95BD45FCE99ED54A8AD7A7091109F51394442916BD154D1DE4379D97647"
        )

        // GB/T 32918.3-2016 A.2 Example 4
        testKatHex(
            digest(),
            "02" +
                    "2AF86EFE732CF12AD0E09A1F2556CC650D9CCCE3E249866BBB5C6846A4C4A295" +
                    "FF49D95BD45FCE99ED54A8AD7A7091109F51394442916BD154D1DE4379D97647",
            "284C8F198F141B502E81250F1581C7E9EEB4CA6990F9E02DF388B45471F5BC5C"
        )

        // GB/T 32918.3-2016 A.2 Example 5
        testKatHex(
            digest(),
            "03" +
                    "2AF86EFE732CF12AD0E09A1F2556CC650D9CCCE3E249866BBB5C6846A4C4A295" +
                    "FF49D95BD45FCE99ED54A8AD7A7091109F51394442916BD154D1DE4379D97647",
            "23444DAF8ED7534366CB901C84B3BDBB63504F4065C1116C91A4C00697E6CF7A"
        )

        // GB/T 32918.3-2016 A.3 Example 2
        testKatHex(
            digest(),
            "008842494C4C343536405941484F4F2E434F4D" +
                    "00" +
                    "0000000000000000000000000000000000000000000000000000000000000000" +
                    "00" +
                    "E78BCD09746C202378A7E72B12BCE00266B9627ECB0B5A25367AD1AD4CC6242B" +
                    "00" +
                    "CDB9CA7F1E6B0441F658343F4B10297C0EF9B6491082400A62E7A7485735FADD" +
                    "01" +
                    "3DE74DA65951C4D76DC89220D5F7777A611B1C38BAE260B175951DC8060C2B3E" +
                    "00" +
                    "34297DD83AB14D5B393B6712F32B2F2E938D4690B095424B89DA880C52D4A7D9" +
                    "01" +
                    "99BBF11AC95A0EA34BBD00CA50B93EC24ACB68335D20BA5DCFE3B33BDBD2B62D",
            "557BAD30E183559AEEC3B2256E1C7C11F870D22B165D015ACF9465B09B87B527"
        )

        // GB/T 32918.3-2016 A.3 Example 3
        testKatHex(
            digest(),
            "00DADD087406221D657BC3FA79FF329BB022E9CB7DDFCFCCFE277BE8CD4AE9B9" +
                    "54ECF0080215977B2E5D6D61B98A99442F03E8803DC39E349F8DCA5621A9ACDF" +
                    "2B557BAD30E183559AEEC3B2256E1C7C11F870D22B165D015ACF9465B09B87B5" +
                    "270181076543ED19058C38B313D739921D46B80094D961A13673D4A5CF8C7159" +
                    "E30401D8CFFF7CA27A01A2E88C18673748FDE9A74C1F9B45646ECA0997293C15" +
                    "C34DD8002A4832B4DCD399BAAB3FFFE7DD6CE6ED68CC43FFA5F2623B9BD04E46" +
                    "8D322A2A0016599BB52ED9EAFAD01CFA453CF3052ED60184D2EECFD42B52DB74" +
                    "110B984C23",
            "E05FE287B73B0CE6639524CD86694311562914F4F6A3424101D885F88B05369C"
        )

        // GB/T 32918.3-2016 A.3 Example 4
        testKatHex(
            digest(),
            "02" +
                    "01" +
                    "F0464B1E81684E5ED6EF281B55624EF46CAA3B2D37484372D91610B698252CC9" +
                    "E05FE287B73B0CE6639524CD86694311562914F4F6A3424101D885F88B05369C",
            "4EB47D28AD3906D6244D01E0F6AEC73B0B51DE1574C13798184E4833DBAE295A"
        )

        // GB/T 32918.3-2016 A.3 Example 5
        testKatHex(
            digest(),
            "03" +
                    "01" +
                    "F0464B1E81684E5ED6EF281B55624EF46CAA3B2D37484372D91610B698252CC9" +
                    "E05FE287B73B0CE6639524CD86694311562914F4F6A3424101D885F88B05369C",
            "588AA67064F24DC27CCAA1FAB7E27DFF811D500AD7EF2FB8F69DDF48CC0FECB7"
        )

        // GB/T 32918.4-2016 A.2 Example 1
        testKatHex(
            digest(),
            "57E7B63623FAE5F08CDA468E872A20AFA03DED41BF140377656E637279707469" +
                    "6F6E207374616E646172640E040DC83AF31A67991F2B01EBF9EFD8881F0A0493" +
                    "000603",
            "6AFB3BCEBD76F82B252CE5EB25B5799686902B8CF2FD87536E55EF7603B09E7C"
        )

        // GB/T 32918.4-2016 A.2 Example 2
        testKatHex(
            digest(),
            "64D20D27D0632957F8028C1E024F6B02EDF23102A566C932AE8BD613A8E865FE" +
                    "656E6372797074696F6E207374616E6461726458D225ECA784AE300A81A2D482" +
                    "81A828E1CEDF11C4219099840265375077BF78",
            "9C3D7360C30156FAB7C80A0276712DA9D8094A634B766D3A285E07480653426D"
        )

        // GB/T 32918.4-2016 A.3 Example 1
        testKatHex(
            digest(),
            "01C6271B31F6BE396A4166C0616CF4A8ACDA5BEF4DCBF2DD42656E6372797074" +
                    "696F6E207374616E646172640147AF35DFA1BFE2F161521BCF59BAB83564868D" +
                    "9295881735",
            "F0A41F6F48AC723CECFC4B767299A5E25C0641679FBD2D4D20E9FFD5B9F0DAB8"
        )

        // GB/T 32918.4-2016 A.3 Example 2
        testKatHex(
            digest(),
            "0083E628CF701EE3141E8873FE55936ADF24963F5DC9C6480566C80F8A1D8CC5" +
                    "1B656E6372797074696F6E207374616E6461726401524C647F0C0412DEFD468B" +
                    "DA3AE0E5A80FCC8F5C990FEE11602929232DCD9F36",
            "73A48625D3758FA37B3EAB80E9CFCABA665E3199EA15A1FA8189D96F579125E4"
        )
    }
}
