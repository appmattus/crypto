/*
 * Copyright 2021 Appmattus Limited
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package com.appmattus.crypto.internal

import com.appmattus.crypto.internal.core.XXH3_128
import com.appmattus.crypto.internal.core.encodeBELong
import com.appmattus.crypto.internal.core.sphlib.encodeLatin1
import com.appmattus.crypto.internal.core.sphlib.toHexString
import kotlin.test.Test
import kotlin.test.assertEquals

@Suppress("ClassName")
class XXH3_128Test {

    @Test
    fun test3_128OneShotWithSeed() {
        // From https://github.com/daisuke-t-jp/xxHash-Swift/blob/master/Tests/xxHashTests/xxHashTests.swift

        val seed = 0x000000007fffffffL

        testXXH3_128("", 0, "00000000000000000000000000000000")
        testXXH3_128("", 1, "0000000000000001ffffffffffffffff")
        testXXH3_128("", seed, "000000007fffffffffffffff80000001")
        testXXH3_128("1", 0, "bfd4fee95132690016f62217f6b7760e")
        testXXH3_128("1", 1, "e985e81a4014f5046e2538a6fe7d16ba")
        testXXH3_128("1", seed, "e58a6964882dab128b1b8fc68ef5764e")
        testXXH3_128("12", 0, "514ac985b8428585fdf765fd7962ae27")
        testXXH3_128("12", 1, "aab2a0490e310c0150ae7a370e66bbda")
        testXXH3_128("12", seed, "6b482270b7d6fc56e4fc6d2a7e1b0c7f")
        testXXH3_128("123", 0, "3a5b5b075931bda515788b8bc97d6ca8")
        testXXH3_128("123", 1, "c69d32f9a2c7fa3e089b61b12c2203c7")
        testXXH3_128("123", seed, "eed81d488944553b60fb25e51ce26eff")
        testXXH3_128("1234", 0, "8e713578ea77a06541915929709502f3")
        testXXH3_128("1234", 1, "df3f2b4f85a52a82384b33af9191d34a")
        testXXH3_128("1234", seed, "29f7acace41d88d975c55bf8387d2736")
        testXXH3_128("12345", 0, "9698e4438f7cdbe22978b2097d8bd650")
        testXXH3_128("12345", 1, "22b7ee10d5a42abff8d9572fb21585dd")
        testXXH3_128("12345", seed, "3957a352a957771f778aa2118a05b24a")
        testXXH3_128("123456", 0, "55b6084d0f7e3f2bbadc034740df6c28")
        testXXH3_128("123456", 1, "438227b2546a1bb23498261a2b264622")
        testXXH3_128("123456", seed, "716740783a5e014559e287c57d15da48")
        testXXH3_128("1234567", 0, "02e2893761c6afe8256b02d617f01efc")
        testXXH3_128("1234567", 1, "edaef9a2003042f81b794ef05d6a5c25")
        testXXH3_128("1234567", seed, "73b56e2f4d65df9af7bfe3ac621e8852")
        testXXH3_128("12345678", 0, "5281257c467734948845cd7721ca41c7")
        testXXH3_128("12345678", 1, "cdf25edfe3521d8394fee7f2bde7ed29")
        testXXH3_128("12345678", seed, "5ef89da5bb195e60210739b637afb716")
        testXXH3_128("123456789", 0, "7c504ed0746ffcc9d854a155e38d334c")
        testXXH3_128("123456789", 1, "121100d1fb6945c91109082bc8ce910f")
        testXXH3_128("123456789", seed, "2f9d8b9e671ef7f94ed290b3420f70b6")
        testXXH3_128("123456789A", 0, "65eb8a6e6a03363df4772798f7c2fdf1")
        testXXH3_128("123456789A", 1, "201f2d286f16e277afd846088829171c")
        testXXH3_128("123456789A", seed, "6d3e6fe85f66ca1c2b66fdd206f7057e")
        testXXH3_128("123456789AB", 0, "c10b0cc434f8337b2cb4343fa811a289")
        testXXH3_128("123456789AB", 1, "b63b174a53a4a800383b43f97663c7c0")
        testXXH3_128("123456789AB", seed, "1b0b21b6d145bc0381dcae55b6d36e44")
        testXXH3_128("123456789ABC", 0, "69d1844712cf7eb7e9a1f967f6aac95a")
        testXXH3_128("123456789ABC", 1, "636ef6b01d90cbdaa1877a7d3927772b")
        testXXH3_128("123456789ABC", seed, "4fed8c1b86e6689666ce5993a0f97311")
        testXXH3_128("123456789ABCD", 0, "6bec7eb536423cc132bc5a08ae049a86")
        testXXH3_128("123456789ABCD", 1, "a99a5b8bc8c9ae2d49aa8a19c96b84de")
        testXXH3_128("123456789ABCD", seed, "4fa69917d3a26d9e190087f46126fe80")
        testXXH3_128("123456789ABCDE", 0, "422fb173b4713ccc183b99edf19bcfc6")
        testXXH3_128("123456789ABCDE", 1, "0fbfe5ef43091fd465bb7adfbe120d4c")
        testXXH3_128("123456789ABCDE", seed, "381f62782ad9f0a846ba4c52ce2cf82d")
        testXXH3_128("123456789ABCDEF", 0, "208cfe2ef00d2aaa9b72015eec4abbf3")
        testXXH3_128("123456789ABCDEF", 1, "dd2065fa447893b04387b3dfee532765")
        testXXH3_128("123456789ABCDEF", seed, "50554db504518e64c8fb00b18f99658c")
        testXXH3_128("123456789ABCDEF1", 0, "79e87cbf1cf3e1f0c6a448dedab7f6df")
        testXXH3_128("123456789ABCDEF1", 1, "bb771495aa7bdeed025af1c531a87103")
        testXXH3_128("123456789ABCDEF1", seed, "1ccc4521cb46e9f4d018cd9640a8025f")
        testXXH3_128("123456789ABCDEF12", 0, "3212a824b68db770b1c8487428be8f41")
        testXXH3_128("123456789ABCDEF12", 1, "84bd64375cf5306eb898b815639a1f0e")
        testXXH3_128("123456789ABCDEF12", seed, "3964270cb37ca852d3a4c6e517054497")
        testXXH3_128("123456789ABCDEF123", 0, "e851610a1c65402c4f2f267c5d1538fe")
        testXXH3_128("123456789ABCDEF123", 1, "bce89191f8dffebb1ea19fa67f2fb10c")
        testXXH3_128("123456789ABCDEF123", seed, "2d7324f73592729ea0567b9bdc9955d4")
        testXXH3_128("123456789ABCDEF1234", 0, "df454bba14d0f7186cac0dda7929a2dc")
        testXXH3_128("123456789ABCDEF1234", 1, "38bd3aef4cb864596c898c2b4e588857")
        testXXH3_128("123456789ABCDEF1234", seed, "65af3d37c94d8ba9622b1880cb625594")
        testXXH3_128("123456789ABCDEF12345", 0, "24aff65936aabd66fb5f07080f6223cc")
        testXXH3_128("123456789ABCDEF12345", 1, "f800ce6c6c9e12f291629be0033e89d4")
        testXXH3_128("123456789ABCDEF12345", seed, "14d5975b47f3d0f1b214d00b4b21c87b")
        testXXH3_128("123456789ABCDEF123456", 0, "d9af6e46b19817f187ca30856954ad47")
        testXXH3_128("123456789ABCDEF123456", 1, "0cc4bcdb86d6f479aeb928126ca862e0")
        testXXH3_128("123456789ABCDEF123456", seed, "c91f939c21af39ca0c0a121385c898e3")
        testXXH3_128("123456789ABCDEF1234567", 0, "92066eb29c023a36df3838e8631f75f4")
        testXXH3_128("123456789ABCDEF1234567", 1, "3ccc3cdc5d828d2ee370a495f57c511a")
        testXXH3_128("123456789ABCDEF1234567", seed, "352d2853db18081f01e719017aa78ad6")
        testXXH3_128("123456789ABCDEF12345678", 0, "b6458f0b55c608a38705aa3a6c18bd8c")
        testXXH3_128("123456789ABCDEF12345678", 1, "2491326f5e18bd51186904141f9ee7f4")
        testXXH3_128("123456789ABCDEF12345678", seed, "753433a5ef6137d37fa477cf6ab3e0a2")
        testXXH3_128("123456789ABCDEF123456789", 0, "5f607369f90f729d50d23d1208cf3ca0")
        testXXH3_128("123456789ABCDEF123456789", 1, "b94738d1e8170e54ab99a97c198bf7e1")
        testXXH3_128("123456789ABCDEF123456789", seed, "f3960f7ebeea41864afaa88ad2ccda24")
        testXXH3_128("123456789ABCDEF123456789A", 0, "4fa0d1c126f52cd74b1b641b76bd2e7b")
        testXXH3_128("123456789ABCDEF123456789A", 1, "15a151f5157faa5c4a7b38092f4d53bf")
        testXXH3_128("123456789ABCDEF123456789A", seed, "cc90128c4ce6c5ad292cd36177668750")
        testXXH3_128("123456789ABCDEF123456789AB", 0, "ff39c191f47f2094e5a028dadeb901ea")
        testXXH3_128("123456789ABCDEF123456789AB", 1, "7759e49a3f1939bcb62114b2152687d3")
        testXXH3_128("123456789ABCDEF123456789AB", seed, "54c36137c684134cd0aeda9b7df62d73")
        testXXH3_128("123456789ABCDEF123456789ABC", 0, "8e5cd1fae1b3386a518a3484191f8ef8")
        testXXH3_128("123456789ABCDEF123456789ABC", 1, "7ae4271c971f3569b63fa73be852edaf")
        testXXH3_128("123456789ABCDEF123456789ABC", seed, "37f1499737cd79dfd60941c039d5a6e8")
        testXXH3_128("123456789ABCDEF123456789ABCD", 0, "ad056c675bc31b6ea1f6a37c12db3b5e")
        testXXH3_128("123456789ABCDEF123456789ABCD", 1, "b9c10559b04386d96ea27551b6fdd624")
        testXXH3_128("123456789ABCDEF123456789ABCD", seed, "ff4ccc04c6fbb53c1a7587ef78498514")
        testXXH3_128("123456789ABCDEF123456789ABCDE", 0, "9e4d4e52b3eb5b5e257c7d01e545b03b")
        testXXH3_128("123456789ABCDEF123456789ABCDE", 1, "5540bc1f65e388fc40e44f1ea0fe26e3")
        testXXH3_128("123456789ABCDEF123456789ABCDE", seed, "6c710acfa82903330c7999c4802c8f1c")
        testXXH3_128("123456789ABCDEF123456789ABCDEF", 0, "fad8149974d64a933437d4e5cdc0ca86")
        testXXH3_128("123456789ABCDEF123456789ABCDEF", 1, "c0e78ef91b3345dc94c06f2c19c1bd95")
        testXXH3_128("123456789ABCDEF123456789ABCDEF", seed, "42ac5aa12608e896cf7608a4ca747d17")
        testXXH3_128("123456789ABCDEF123456789ABCDEF1", 0, "070a5ac4c8f22ccb8825bb6b2924d3e4")
        testXXH3_128("123456789ABCDEF123456789ABCDEF1", 1, "b336debe6f5f38ae343a239d659d2d0d")
        testXXH3_128("123456789ABCDEF123456789ABCDEF1", seed, "79aa34e6a542c2504bc5c53d8cada6b1")
        testXXH3_128("123456789ABCDEF123456789ABCDEF12", 0, "3fcbfd74588ca33200e3b96e652a3145")
        testXXH3_128("123456789ABCDEF123456789ABCDEF12", 1, "ea6a24e48e2d40c1edef63764077120d")
        testXXH3_128("123456789ABCDEF123456789ABCDEF12", seed, "937bf2b5d54d1fe94eabf0b1e812643d")
        testXXH3_128("123456789ABCDEF123456789ABCDEF123", 0, "752224547cf69847055009c73e23f10f")
        testXXH3_128("123456789ABCDEF123456789ABCDEF123", 1, "b72208db02841950eae0a358bb5e587f")
        testXXH3_128("123456789ABCDEF123456789ABCDEF123", seed, "4e2a5eecdade8659321738425fc3c6f9")
        testXXH3_128("123456789ABCDEF123456789ABCDEF1234", 0, "084e980295b897e5652134ad918632d5")
        testXXH3_128("123456789ABCDEF123456789ABCDEF1234", 1, "8ae0c2e87b530cfc1f25da9d35bd31a3")
        testXXH3_128("123456789ABCDEF123456789ABCDEF1234", seed, "382f28c1b68ebf68f262959bbe4d5dd8")
        testXXH3_128("123456789ABCDEF123456789ABCDEF12345", 0, "bba92e5a949394a11c06b275a3b409e6")
        testXXH3_128("123456789ABCDEF123456789ABCDEF12345", 1, "63287a287d8e175a4ecec27afdf22fed")
        testXXH3_128("123456789ABCDEF123456789ABCDEF12345", seed, "8b866c525c1cde10348df308972ea64b")
        testXXH3_128("123456789ABCDEF123456789ABCDEF123456", 0, "1cc2d9a246b4f2711938e77f9a74710d")
        testXXH3_128("123456789ABCDEF123456789ABCDEF123456", 1, "14800c26e9a3abae2123c30566d3b67b")
        testXXH3_128("123456789ABCDEF123456789ABCDEF123456", seed, "149fa1abc71dd6d0b90fbf12feebb017")
        testXXH3_128("123456789ABCDEF123456789ABCDEF1234567", 0, "1baeb21460403a60df86a5f377ef44c5")
        testXXH3_128("123456789ABCDEF123456789ABCDEF1234567", 1, "9293b41dce1b90172dfbf94f492f0a1b")
        testXXH3_128("123456789ABCDEF123456789ABCDEF1234567", seed, "918b80f2355bf0abf70f6dd079000838")
        testXXH3_128("123456789ABCDEF123456789ABCDEF12345678", 0, "82f05b31d0e91863ff445151155abf81")
        testXXH3_128("123456789ABCDEF123456789ABCDEF12345678", 1, "9b032a78f1ecdef5eef68d8ce18a7d53")
        testXXH3_128("123456789ABCDEF123456789ABCDEF12345678", seed, "caaa2ef43867d1d7f927e2f2ce305043")
        testXXH3_128("123456789ABCDEF123456789ABCDEF123456789", 0, "3c9a9207d4b137c2aeb06fcdbee72648")
        testXXH3_128("123456789ABCDEF123456789ABCDEF123456789", 1, "2f1713164be5ac882273805458d37e03")
        testXXH3_128("123456789ABCDEF123456789ABCDEF123456789", seed, "bd9183372b853c49544d38bf296f3e53")
        testXXH3_128(
            "123456789ABCDEF123456789ABCDEF123456789ABCDEF123456789ABCDEF123456789ABCDEF123456789ABCDEF",
            0,
            "b4eafd4ffe603a99ad679fa80f3beace"
        )
        testXXH3_128(
            "123456789ABCDEF123456789ABCDEF123456789ABCDEF123456789ABCDEF123456789ABCDEF123456789ABCDEF",
            1,
            "8b1828e6b3e08fa6b04179c10a9df59b"
        )
        testXXH3_128(
            "123456789ABCDEF123456789ABCDEF123456789ABCDEF123456789ABCDEF123456789ABCDEF123456789ABCDEF",
            seed,
            "54d1f604eee244c8d1020265ff1c3eab"
        )
        testXXH3_128(
            "123456789ABCDEF123456789ABCDEF123456789ABCDEF123456789ABCDEF123456789ABCDEF123456789ABCDEF123456789ABCDEF",
            0,
            "21d02847f9832971ff3a60f4a107d4cf"
        )
        testXXH3_128(
            "123456789ABCDEF123456789ABCDEF123456789ABCDEF123456789ABCDEF123456789ABCDEF123456789ABCDEF123456789ABCDEF",
            1,
            "c642807e7ae2697ffe0cbe6bab6f9c77"
        )
        testXXH3_128(
            "123456789ABCDEF123456789ABCDEF123456789ABCDEF123456789ABCDEF123456789ABCDEF123456789ABCDEF123456789ABCDEF",
            seed,
            "62fb4da607ac6b43c666993fa989a272"
        )
        testXXH3_128(
            "123456789ABCDEF123456789ABCDEF123456789ABCDEF123456789ABCDEF123456789ABCDEF123456789ABCDEF123456789ABCDEF123456789ABCDEF123456789ABCDEF",
            0,
            "aec21fe976aca4346894dab448099f61"
        )
        testXXH3_128(
            "123456789ABCDEF123456789ABCDEF123456789ABCDEF123456789ABCDEF123456789ABCDEF123456789ABCDEF123456789ABCDEF123456789ABCDEF123456789ABCDEF",
            1,
            "1b8d760adf9d0c8c067ee0b937acb520"
        )
        testXXH3_128(
            "123456789ABCDEF123456789ABCDEF123456789ABCDEF123456789ABCDEF123456789ABCDEF123456789ABCDEF123456789ABCDEF123456789ABCDEF123456789ABCDEF",
            seed,
            "087717520afd31df6823dc649a00cd03"
        )

        val hundredKB = ByteArray(1024 * 100) { 0xff.toByte() }
        testXXH3_128(hundredKB, 0, "22a9f98d693a6933c4643e7a1376f3b1")
        testXXH3_128(hundredKB, 1, "0e93fb3e0b5939b8229c3f7416049fa8")
        testXXH3_128(hundredKB, seed, "8ad7d4c7b2f2d844046699c7597fc19b")
    }

    companion object {
        private fun testXXH3_128(input: String, seed: Long, expected: String) {
            val hash = XXH3_128().digest(encodeLatin1(input), seed)

            val digest = ByteArray(16)
            encodeBELong(hash[0], digest, 0)
            encodeBELong(hash[1], digest, 8)

            assertEquals(expected, digest.toHexString())
        }

        private fun testXXH3_128(input: ByteArray, seed: Long, expected: String) {
            val hash = XXH3_128().digest(input, seed)

            val digest = ByteArray(16)
            encodeBELong(hash[0], digest, 0)
            encodeBELong(hash[1], digest, 8)

            assertEquals(expected, digest.toHexString())
        }
    }
}
